/**
 * Bracelet API
 * API endpoints for NFC bracelet management - Using SQLite database
 */

import { braceletService, userService } from '@/db/services';
import db from '@/db/database';
import type {
  BraceletInfo,
  LinkBraceletRequest,
  BraceletAccessLog,
  QRCodeData,
} from '@/types/bracelet';

// Demo user ID for local development
const DEMO_USER_ID = 'user-demo-001';

/**
 * Get bracelet status and information
 */
export async function getBraceletStatus(): Promise<BraceletInfo | null> {
  try {
    const bracelet = await braceletService.getByUserId(DEMO_USER_ID);
    const user = await userService.getById(DEMO_USER_ID);

    if (!bracelet || !user) {
      return null;
    }

    return {
      id: bracelet.id,
      nfcId: bracelet.nfcId,
      status: bracelet.status as 'active' | 'inactive' | 'lost',
      linkedDate: bracelet.linkedDate,
      lastAccessed: bracelet.lastAccessed,
      accessCount: bracelet.accessCount,
      qrCodeUrl: bracelet.qrCodeUrl,
      emergencyUrl: `https://medguard.app/emergency/${user.id}?nfc=${bracelet.nfcId}`,
    };
  } catch (error) {
    console.error('[Bracelet API] Error getting bracelet status:', error);
    return null;
  }
}

/**
 * Link NFC bracelet to user profile
 */
export async function linkBracelet(data: LinkBraceletRequest): Promise<BraceletInfo> {
  try {
    const user = await userService.getById(DEMO_USER_ID);

    if (!user) {
      throw new Error('User not found');
    }

    // Check if bracelet with this NFC ID already exists
    const existingBracelet = await braceletService.getByNfcId(data.nfcId);
    if (existingBracelet) {
      throw new Error('This bracelet is already linked to an account');
    }

    // Create new bracelet
    const id = Math.random().toString(36).substring(2, 15);
    const now = new Date().toISOString();
    const qrCodeUrl = `https://medguard.app/emergency/${user.id}?nfc=${data.nfcId}`;

    await db.runAsync(
      `INSERT INTO bracelet (id, userId, nfcId, status, linkedDate, lastAccessed, accessCount, qrCodeUrl, createdAt, updatedAt)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
      [id, DEMO_USER_ID, data.nfcId, 'active', now, null, 0, qrCodeUrl, now, now]
    );

    return {
      id,
      nfcId: data.nfcId,
      status: 'active',
      linkedDate: now,
      lastAccessed: undefined,
      accessCount: 0,
      qrCodeUrl,
      emergencyUrl: qrCodeUrl,
    };
  } catch (error) {
    console.error('[Bracelet API] Error linking bracelet:', error);
    throw error;
  }
}

/**
 * Unlink bracelet from user profile
 */
export async function unlinkBracelet(): Promise<{ message: string }> {
  try {
    const bracelet = await braceletService.getByUserId(DEMO_USER_ID);

    if (!bracelet) {
      throw new Error('No bracelet linked');
    }

    await db.runAsync('DELETE FROM bracelet WHERE id = ?', [bracelet.id]);

    return { message: 'Bracelet unlinked successfully' };
  } catch (error) {
    console.error('[Bracelet API] Error unlinking bracelet:', error);
    throw error;
  }
}

/**
 * Update bracelet status
 */
export async function updateBraceletStatus(
  status: 'active' | 'inactive' | 'lost'
): Promise<BraceletInfo> {
  try {
    const bracelet = await braceletService.getByUserId(DEMO_USER_ID);

    if (!bracelet) {
      throw new Error('No bracelet linked');
    }

    await braceletService.updateStatus(bracelet.id, status);

    const updated = await getBraceletStatus();
    if (!updated) {
      throw new Error('Failed to update bracelet status');
    }

    return updated;
  } catch (error) {
    console.error('[Bracelet API] Error updating bracelet status:', error);
    throw error;
  }
}

/**
 * Generate QR code for emergency profile
 */
export async function generateQRCode(): Promise<QRCodeData> {
  try {
    const bracelet = await braceletService.getByUserId(DEMO_USER_ID);
    const user = await userService.getById(DEMO_USER_ID);

    if (!bracelet || !user) {
      throw new Error('No bracelet linked');
    }

    const profileUrl = `https://medguard.app/emergency/${user.id}?nfc=${bracelet.nfcId}`;
    const emergencyId = `EMG-${new Date().getFullYear()}-${bracelet.nfcId.substring(0, 6)}`;

    // Generate a simple QR code SVG (in production, use a proper QR library)
    const qrCodeDataUrl = await generateQRCodeImage(profileUrl);

    return {
      url: profileUrl,
      profileUrl,
      qrCode: qrCodeDataUrl,
      qrCodeDataUrl,
      emergencyId,
      expiresAt: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString(), // 1 year
    };
  } catch (error) {
    console.error('[Bracelet API] Error generating QR code:', error);
    throw error;
  }
}

/**
 * Generate QR code image (placeholder - in production use a real QR library)
 */
async function generateQRCodeImage(data: string): Promise<string> {
  // For demo purposes, return a placeholder QR code PNG
  // In production, use libraries like 'qrcode' or 'react-native-qrcode-svg'

  // Return a simple placeholder QR code image (a PNG data URL)
  // This is a 300x300 black and white QR-like pattern
  return `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAABBBSURBVHhe7dJBDQAwDMCwg39POxLK0Zf2UJxdAARYsACLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCxAIsFWCzAYgEWC7BYgMUCLBZgsQCLBVgswGIBFguwWIDFAiwWYLEAiwVYLMBiARYLsFiAxQIsFmCx4PfP0JQAAAAAAuBv/6wQAAAAAAAAAAAAAAAAAAAAAAAAAAC4C1uYAAACABtAB`;
}

/**
 * Get bracelet access logs
 */
export async function getAccessLogs(limit: number = 20): Promise<BraceletAccessLog[]> {
  try {
    const bracelet = await braceletService.getByUserId(DEMO_USER_ID);

    if (!bracelet) {
      return [];
    }

    const logs = await db.getAllAsync<any>(
      'SELECT * FROM bracelet_access WHERE braceletId = ? ORDER BY accessedAt DESC LIMIT ?',
      [bracelet.id, limit]
    );

    return logs.map((log) => ({
      id: log.id,
      braceletId: log.braceletId,
      accessedAt: log.accessedAt,
      location: log.location,
      ipAddress: log.ipAddress,
      userAgent: undefined, // Not in current schema
    }));
  } catch (error) {
    console.error('[Bracelet API] Error getting access logs:', error);
    throw error;
  }
}

/**
 * Test emergency profile link
 */
export async function testEmergencyProfile(): Promise<{ url: string; valid: boolean }> {
  try {
    const bracelet = await braceletService.getByUserId(DEMO_USER_ID);
    const user = await userService.getById(DEMO_USER_ID);

    if (!bracelet || !user) {
      return { url: '', valid: false };
    }

    const url = `https://medguard.app/emergency/${user.id}?nfc=${bracelet.nfcId}`;

    return {
      url,
      valid: true,
    };
  } catch (error) {
    console.error('[Bracelet API] Error testing emergency profile:', error);
    return { url: '', valid: false };
  }
}

export const braceletApi = {
  getBraceletStatus,
  linkBracelet,
  unlinkBracelet,
  updateBraceletStatus,
  generateQRCode,
  getAccessLogs,
  testEmergencyProfile,
};
